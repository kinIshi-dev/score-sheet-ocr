# JPAスコアシートフォーマット仕様

**最終更新**: 2025-12-21
**対象**: JPA 9-BALL SCORESHEET (チーム対抗戦)

---

## 概要

JPA 9-BALLのチーム対抗戦では、**5人 vs 5人**で対戦する。
1試合につき、**2枚のスコアシート**が存在する（各チームが1枚ずつ記入）。

```
1試合 = Aチーム(5人) vs Bチーム(5人)
      = 5つの個人戦

スコアシート:
├─ Aチーム用スコアシート (1枚) ← Aチームが記入
└─ Bチーム用スコアシート (1枚) ← Bチームが記入
```

同じ試合結果を2枚のシートに記録することで、精度と確度を高めている。

---

## 用紙構成

1枚のスコアシートには**5試合分の記録**が記載される。

```
┌─────────────────────────────┐
│  JPA 9-BALL SCORESHEET       │
│                              │
│  試合1: 自チーム選手1の記録   │
│  試合2: 自チーム選手2の記録   │
│  試合3: 自チーム選手3の記録   │
│  試合4: 自チーム選手4の記録   │
│  試合5: 自チーム選手5の記録   │
│                              │
└─────────────────────────────┘
```

**各試合記録エリア**:
- 1試合 = 自チームの1選手 vs 相手チームの1選手
- 各試合記録は複数の物理的な行にまたがる
- 自チーム選手の情報のみを記録（番号、名前、スキル、スコアなど）

---

## 対戦方式

- **5人が5人と個別に対戦** → 合計5試合
- 各選手は相手チームの1人と1対1で9-ballを対戦
- 各個人戦の結果をスコアシートに記録

---

## 各試合記録のフィールド

各試合記録エリアには、自チーム選手1名の情報が記載され、以下のフィールドを含む：

### 1. 選手番号 (必須) 🔴
- **位置**: 行の左端
- **形式**: 数字（1桁〜2桁）
- **例**: 1, 2, 3, 4, 5

### 2. 選手名 (抽出推奨) 🟡
- **位置**: 選手番号の右
- **形式**: 手書き文字（カタカナ、漢字、アルファベット）
- **備考**: 番号で特定可能なため優先度は中

### 3. スキルレベル (必須) 🔴
- **位置**: 選手名の右、斜めに区切られたマスの**左上**
- **形式**: 数字 1〜9
- **例**: 5, 7, 9
- **重要**: このフィールドは斜め線で区切られた小さなマス

### 4. 合計イニング (必須) 🔴
- **位置**: 特定のカラム（グリッド内）
- **形式**: 数字
- **説明**: その選手が使用した総イニング数

### 5. セーフティ数 (必須) 🔴
- **位置**: 特定のカラム（グリッド内）
- **形式**: 数字
- **説明**: セーフティプレイの回数

### 6. 合計得点 (必須) 🔴
- **位置**: 右側のエリア
- **形式**: 数字（通常1桁〜2桁）
- **説明**: その選手が獲得したラック数

### 7. 試合得点 (必須) 🔴
- **位置**: グリッドエリア or 右側
- **形式**: 数字
- **説明**: 最終的な試合スコア

### 8. 試合時間 (必須) 🔴
- **位置**: 各試合記録の下部またはフッター
- **形式**: 時:分 または 分のみ
- **例**: 45分、1:30

---

## グリッドエリアの構造

**横軸**: ラック番号（累積スコア表示）
- 例: 10, 14, 19, 25, 31, 35, 38, 40, 50, 55, 60, 65, 70, 75

**縦軸**: 各選手のラック記録
- 各選手に複数行割り当て
- ラック取得は正の字（｜、｜｜、｜｜｜、｜｜｜｜、卌）でカウント

**記録内容**:
- ラック勝利数のカウント
- イニング数
- セーフティ数
- その他メモ

---

## OCRで抽出すべき主要データ（優先順位付き）

### 優先度: 最高 🔴🔴

1. **選手番号** (各選手)
   - 位置: 各行の左端
   - 形式: 数字 1〜2桁
   - 重要度: 選手特定の主キー

2. **スキルレベル** (各選手)
   - 位置: 選手名右の斜めマス左上
   - 形式: 数字 1〜9
   - 重要度: ハンディキャップ計算に必須

3. **合計得点** (各選手)
   - 位置: 右側エリア
   - 形式: 数字
   - 重要度: 勝敗判定に必須

### 優先度: 高 🔴

4. **合計イニング** (各選手)
   - 位置: グリッド内特定カラム
   - 形式: 数字

5. **セーフティ数** (各選手)
   - 位置: グリッド内特定カラム
   - 形式: 数字

6. **試合得点** (各選手)
   - 位置: グリッドまたは右側
   - 形式: 数字

7. **試合時間**
   - 位置: 下部/フッター
   - 形式: 時:分

### 優先度: 中 🟡

8. **選手名** (各選手)
   - 位置: 選手番号の右
   - 形式: 手書き文字
   - 備考: 番号で特定可能だが、確認用に有用

9. **日付**
   - 位置: ヘッダー
   - 形式: 年/月/日

10. **大会名/節数**
    - 位置: ヘッダー
    - 形式: テキスト

### 優先度: 低 🟢

11. **ラックごとの詳細記録**
    - 位置: グリッド内
    - 形式: 正の字カウント
    - 備考: Phase 2以降で対応

---

## データ構造例（JSON）

```json
{
  "match_id": "2025_autumn_match_01",
  "date": "2025-12-21",
  "tournament": "2025秋リーグ",
  "sheet_type": "team_a",
  "total_match_time": "45分",
  "players": [
    {
      "section": "upper",
      "player_number": 1,
      "player_name": "タナカ",
      "skill_level": 7,
      "total_innings": 15,
      "safety_count": 3,
      "total_score": 9,
      "match_score": 9,
      "break_holder": true
    },
    {
      "section": "upper",
      "player_number": 2,
      "player_name": "サトウ",
      "skill_level": 5,
      "total_innings": 18,
      "safety_count": 2,
      "total_score": 7,
      "match_score": 7,
      "break_holder": true
    },
    // ... 残り3人
  ]
}
```

---

## 画像特性

### 品質
- **解像度**: スマホ撮影（様々）
- **明るさ**: 概ね良好
- **傾き**: 多少あり
- **歪み**: 軽微なパースペクティブ歪み

### 文字特性
- **印刷文字**: JPAロゴ、タイトル、グリッド数字
- **手書き文字**: 選手名、番号、スコア
- **筆記具**: ボールペン
- **文字サイズ**: 中〜大

### 課題
- スキルレベルは**小さな斜めマス**の中 → 正確なROI抽出が必要
- 手書き文字の個人差
- グリッド線との重なり
- 正の字カウントの認識（Phase 2）

---

## MVP開発での対応方針

### Phase 1（現在） - 基本抽出
1. 1枚の用紙（1チーム分）を処理対象とする
2. 用紙内の5試合分の記録エリアを検出
3. 各試合記録から以下を抽出:
   - ✅ 選手番号
   - ✅ スキルレベル（斜めマス左上）
   - ✅ 合計得点
   - ✅ 試合時間

### Phase 2 - 精度向上
4. テンプレートマッチングで正確なROI抽出
5. 各試合記録から以下を追加抽出:
   - ✅ 合計イニング
   - ✅ セーフティ数
   - ✅ 試合得点
   - ✅ 選手名

### Phase 3 - 完全自動化
6. ラックごとの詳細記録（正の字カウント）
7. 2枚のシート（AチームとBチーム）の照合と整合性チェック
8. 写真内の複数用紙の自動分離と個別処理

---

## 重要な注意点

### スキルレベル抽出の課題
- **斜めに区切られたマス**の左上にある
- マスが小さい → 高精度なROI切り出しが必要
- 事前の画像回転補正が重要

### 2枚のシートの関係
- 同じ試合を異なるチームが記入
- 理想的には同じ結果だが、記入ミスの可能性
- 2枚を照合することで精度向上可能

---

## サンプル画像での観察

### 確認済み
✅ 1枚の用紙 = 1チーム分（5試合）
✅ 写真には通常2枚の用紙が写っている（AチームとBチーム）
✅ 各試合記録エリアに1選手の情報
✅ 選手番号が各記録エリアの左端
✅ スキルレベルは斜めマスの左上
✅ フォーマットは全サンプルで統一

---

## 次のステップ

1. ✅ スコアシートフォーマットの正確な理解
2. 写真から個々の用紙を分離（2枚 → 各1チーム分）
3. 1枚の用紙内で5試合分の記録エリアを検出
4. 各試合記録から以下をOCR抽出:
   - 選手番号のROI → OCR
   - スキルレベルのROI（斜めマス対応）→ OCR
   - 合計得点のROI → OCR
   - 試合時間のROI → OCR
5. JSON/CSV形式で出力

---

**参照サンプル**:
- `data/raw/LINE_ALBUM_2025秋_251221_1.jpg`
- `data/raw/LINE_ALBUM_2025秋_251221_10.jpg`
- `data/raw/LINE_ALBUM_2025秋_251221_25.jpg`
